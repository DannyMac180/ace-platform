# Fly.io Configuration for ACE Platform
# Documentation: https://fly.io/docs/reference/configuration/
#
# Deployment:
#   1. Install flyctl: https://fly.io/docs/hands-on/install-flyctl/
#   2. Create the app: fly launch --no-deploy
#   3. Set up Postgres: fly postgres create --name ace-platform-db
#   4. Attach Postgres: fly postgres attach ace-platform-db
#   5. Set up Redis: fly redis create --name ace-platform-redis
#   6. Set secrets: fly secrets set OPENAI_API_KEY=sk-... JWT_SECRET_KEY=...
#   7. Deploy: fly deploy
#
# Scaling:
#   fly scale count api=2 mcp=1 worker=2 beat=1

app = "ace-platform"
primary_region = "iad"
kill_signal = "SIGTERM"
kill_timeout = 30

# =============================================================================
# Build Configuration
# =============================================================================
[build]
  dockerfile = "Dockerfile"
  target = "production"

# =============================================================================
# Process Groups
# =============================================================================
# Define separate process groups for different components
[processes]
  api = "uvicorn ace_platform.api.main:app --host 0.0.0.0 --port 8000 --workers 2"
  mcp = "python -m ace_platform.mcp.server"
  worker = "celery -A ace_platform.workers.celery_app worker --loglevel=info --concurrency=2"
  beat = "celery -A ace_platform.workers.celery_app beat --loglevel=info"

# =============================================================================
# Environment Variables
# =============================================================================
# Non-sensitive environment variables
# Sensitive variables should be set via: fly secrets set KEY=VALUE
[env]
  ENVIRONMENT = "production"
  DEBUG = "false"
  API_HOST = "0.0.0.0"
  API_PORT = "8000"
  # DATABASE_URL is automatically set by `fly postgres attach`
  # REDIS_URL is automatically set by `fly redis create`

# =============================================================================
# HTTP Service (API)
# =============================================================================
[http_service]
  internal_port = 8000
  force_https = true
  auto_stop_machines = "stop"
  auto_start_machines = true
  min_machines_running = 1
  processes = ["api"]

  [http_service.concurrency]
    type = "requests"
    soft_limit = 200
    hard_limit = 250

  [[http_service.checks]]
    grace_period = "30s"
    interval = "30s"
    method = "GET"
    timeout = "10s"
    path = "/health"

# =============================================================================
# Deploy Configuration
# =============================================================================
[deploy]
  # Run database migrations before starting new instances
  release_command = "alembic upgrade head"
  strategy = "rolling"

# =============================================================================
# Machine Configuration
# =============================================================================
# API server configuration
[[vm]]
  size = "shared-cpu-1x"
  memory = "512mb"
  processes = ["api"]

# MCP server configuration
[[vm]]
  size = "shared-cpu-1x"
  memory = "512mb"
  processes = ["mcp"]

# Worker configuration (needs more resources for LLM processing)
[[vm]]
  size = "shared-cpu-1x"
  memory = "1gb"
  processes = ["worker"]

# Beat scheduler (minimal resources needed)
[[vm]]
  size = "shared-cpu-1x"
  memory = "256mb"
  processes = ["beat"]

# =============================================================================
# Statics (optional - for future frontend)
# =============================================================================
# [[statics]]
#   guest_path = "/app/web/dist"
#   url_prefix = "/static"
